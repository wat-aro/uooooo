# Runtime Reliability Plan

最終更新: 2026-02-22

## Goal
- 実行時の不正挙動を減らし、失敗時に一貫してエラーを返す。
- 入出力境界条件と構文エラー検出のテストカバレッジを強化する。

## Scope
- `src/lib.rs` の VM 実行制御・入力処理・パーサ。
- `src/main.rs` の CLI エラーメッセージ。
- `tests/integrations/main.rs` の失敗系テスト追加。

## Non-Goals
- 言語仕様の拡張（新命令追加など）。
- 既存サンプルプログラムの全面書き換え。

## Plan

### 1. ループ不整合の検出修正
- [ ] 実行終了時に `stack` 残存を検出し `UnmatchedBeginEnd` を返す。
- [ ] `[` 未対応 `]` と `]` 単独の双方で失敗する統合テストを追加する。

完了条件:
- [ ] `おおうう` 系の未クローズループ入力で終了コード 1 になる。

### 2. EOF 入力仕様の明確化と実装
- [ ] `getchar` の戻り値を EOF と通常バイトで区別できる形に変更する。
- [ ] EOF 時のセル値動作を仕様化し、テストに固定する。

完了条件:
- [ ] EOF を含む入力ケースで期待値がテスト化され、再現可能。

### 3. パーサ実装の計算量改善
- [ ] `chars().count()` / `substring` 多用を見直し、線形走査ベースへ変更する。
- [ ] 既存フィクスチャ（`ABC` / `hello_world`）で回帰がないことを確認する。

完了条件:
- [ ] 機能互換を保ったまま、パーサが単一走査で読める構造になる。

### 4. 異常系テスト拡充
- [ ] `pointer_underflow` と `pointer_overflow` の統合テストを追加する。
- [ ] 構文不整合・入力境界を含む失敗パスを最低 5 ケース用意する。

完了条件:
- [ ] 主要エラー種別（Begin/End 不整合、ポインタ範囲、入力境界）を網羅。

### 5. CLI エラー表示改善
- [ ] ファイルオープン失敗時に固定文言ではなく `path` と OS エラーを表示する。
- [ ] 既存成功系の CLI 挙動が変わらないことを確認する。

完了条件:
- [ ] 権限エラーや不在ファイルで原因が判別可能なメッセージが出る。

## Acceptance Criteria
- [ ] `cargo fmt --all`
- [ ] `cargo test`
- [ ] `cargo clippy --all-targets --all-features -- -D warnings`
- [ ] 追加した失敗系テストが期待する終了コードとメッセージを検証している。

## Recommended Execution Order
1. ループ不整合修正
2. EOF 仕様確定
3. 異常系テスト拡充
4. パーサ改善
5. CLI エラー表示改善
